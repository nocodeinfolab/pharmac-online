<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Online Pharmacy</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --accent: #f8f9fa;
            --text: #2b2d42;
            --light-text: #8d99ae;
            --success: #4cc9f0;
            --warning: #f8961e;
            --danger: #f94144;
            --white: #ffffff;
            --light-bg: #f5f7fa;
            --radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --text-sharpness: antialiased;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: var(--text-sharpness);
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--light-bg);
            color: var(--text);
            line-height: 1.6;
            padding-bottom: 80px;
            image-rendering: -webkit-optimize-contrast;
            text-rendering: optimizeLegibility;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .logo img {
            height: 32px;
            border-radius: 5%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .cart-icon {
            position: relative;
            font-size: 1.3rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .cart-icon:hover {
            transform: scale(1.1);
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: var(--white);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .search-container {
            padding: 15px;
            background: var(--white);
            box-shadow: var(--shadow);
            max-width: 1200px;
            margin: 0 auto;
        }

        .search-box {
            display: flex;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .search-box:focus-within {
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }

        .search-input {
            flex: 1;
            padding: 14px 20px;
            border: none;
            font-size: 1rem;
            background: var(--white);
            outline: none;
        }

        .search-button {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 0 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .search-button:hover {
            background: var(--secondary);
        }

        .search-tabs {
            display: flex;
            margin-bottom: 15px;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .search-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: var(--accent);
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .search-tab.active {
            background: var(--primary);
            color: var(--white);
        }

        .categories-container {
            padding: 0 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .category-section {
            margin-bottom: 30px; /* Increased from 25px */
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 2px solid rgba(67, 97, 238, 0.1);
            margin-top: 20px;
        }

        .category-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            text-transform: capitalize;
        }

        .products-container {
            position: relative;
            overflow: visible;
            width: 100%;
            min-width: calc(50% - 10px);
            flex: 0 0 calc(50% - 10px);
            height: auto; /* Increased from 320px */
            margin-bottom: 15px;
        }

        .products-slider {
            display: flex;
            transition: transform 0.5s ease;
            width: 100%;
            gap: 15px;
        }

        .product-card {
            min-width: calc(50% - 10px);
            flex: 0 0 calc(50% - 10px);
            background: var(--white);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            margin: 0;
            border: 1px solid blue;
            display: flex;
            flex-direction: column;
            height: auto; /* Increased height */
            margin-bottom: 15px;
        }

        .product-image {
            width: 100%;
            height: 200px; /* Increased image height */
            object-fit: cover;
            background: var(--light-bg);
        }

        .product-info {
            padding: 10px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .product-name {
            font-size: 0.9rem;
            margin-bottom: 3px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 2.4em;
            line-height: 1.2;
        }

        .product-brand {
            font-size: 0.75rem;
            color: var(--light-text);
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 0;
        }

        .product-price {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stock-badge-container {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .product-stock, .prescription-badge {
            font-size: 0.5rem; /* Smaller font */
            padding: 2px 7px; /* Reduced padding */
            border-radius: 4px;
            display: inline-block;
            font-weight: 500;
        }

        .product-stock {
            background: var(--success);
            color: var(--white);
        }

        .prescription-badge {
            background: var(--warning);
            color: var(--white);
        }

        .add-to-cart-container {
            display: flex;
            margin-top: auto; /* Pushes to bottom */
            gap: 8px;
            padding-top: 8px;
        }

        .quantity-input {
            width: 50px;
            padding: 7px;
            border: 2px solid rgba(67, 97, 238, 0.3);
            border-radius: var(--radius);
            font-size: 0.85rem;
            text-align: center;
            font-weight: 500;
            outline: none;
            transition: var(--transition);
        }

        .quantity-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        .add-to-cart-btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: var(--radius);
            padding: 7px 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
            flex-grow: 1;
            white-space: nowrap;
            position: relative;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .add-to-cart-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .add-to-cart-btn .btn-text {
            visibility: visible;
        }

        .add-to-cart-btn .spinner {
            visibility: hidden;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid var(--white);
            animation: spin 1s linear infinite;
        }

        .add-to-cart-btn.loading .btn-text {
            visibility: hidden;
        }

        .add-to-cart-btn.loading .spinner {
            visibility: visible;
        }

        .add-to-cart-btn:active:not(:disabled) {
            background: var(--secondary);
        }

        .add-to-cart-btn:hover:not(:disabled) {
            background: var(--primary-light);
        }

        .slider-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .slider-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            transition: var(--transition);
        }

        .slider-dot.active {
            background: var(--primary);
            transform: scale(1.3);
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: var(--light-text);
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: var(--light-text);
            grid-column: span 3;
        }

        footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: var(--white);
            padding: 12px 0;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-around;
            z-index: 90;
        }

        .footer-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--light-text);
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            padding: 5px 15px;
            border-radius: 20px;
        }

        .footer-icon i {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        .footer-icon.active {
            color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
            transform: translateY(-5px);
        }

        .footer-icon span {
            font-weight: 500;
        }

        .error-message {
            text-align: center;
            padding: 30px;
            color: var(--danger);
        }

        /* Cart Page Styles */
        .cart-page, .prescription-page, .account-page {
            display: none;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .page-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--primary);
        }

        .close-page {
            background: none;
            border: none;
            font-size: 1.3rem;
            color: var(--light-text);
            cursor: pointer;
            transition: var(--transition);
        }

        .close-page:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        .cart-items, .prescription-items {
            margin-bottom: 25px;
        }

        .cart-item {
            display: flex;
            background: var(--white);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .cart-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }

        .cart-item-image {
            width: 70px;
            height: 70px;
            object-fit: contain;
            margin-right: 15px;
            background: var(--light-bg);
            border-radius: 8px;
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-name {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text);
        }

        .cart-item-price {
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 8px;
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .quantity-control {
            display: flex;
            align-items: center;
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            color: var(--primary);
        }

        .quantity-btn:hover {
            background: rgba(67, 97, 238, 0.1);
        }

        .quantity-value {
            margin: 0 10px;
            min-width: 20px;
            text-align: center;
            font-weight: 500;
        }

        .remove-item {
            color: var(--danger);
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .remove-item:hover {
            text-decoration: underline;
        }

        .cart-summary {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .summary-total {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
            padding-top: 10px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .checkout-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 20px;
            transition: var(--transition);
        }

        .checkout-btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }

        .empty-cart {
            text-align: center;
            padding: 50px 20px;
            color: var(--light-text);
        }

        .empty-cart i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--accent);
        }

        .empty-cart p {
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .back-to-shop {
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
            margin-top: 15px;
            display: inline-block;
            font-weight: 500;
            padding: 8px 20px;
            border: 1px solid var(--primary);
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .back-to-shop:hover {
            background: var(--primary);
            color: var(--white);
        }

        /* Account Page Styles */
        .account-form {
            background: var(--white);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: var(--radius);
            font-size: 0.95rem;
            transition: var(--transition);
            outline: none;
        }

        .form-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .form-input:disabled {
            background: var(--accent);
            color: var(--light-text);
        }

        .save-btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: var(--radius);
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            margin-top: 10px;
        }

        .save-btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }

        .save-btn .spinner {
            display: none;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid var(--white);
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        .save-btn.loading .spinner {
            display: inline-block;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 600;
            margin: 0 auto 20px;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: var(--white);
            padding: 12px 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            max-width: 90%;
            text-align: center;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Responsive Styles */
        @media (min-width: 768px) {
            .product-card {
                min-width: calc(33.333% - 11px);
                flex: 0 0 calc(33.333% - 11px);
            }

            .search-container, .categories-container {
                padding: 20px;
            }

            .account-form {
                padding: 30px;
            }
        }

        @media (min-width: 992px) {
            .product-card {
                min-width: calc(25% - 12px);
                flex: 0 0 calc(25% - 12px);
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: rgba(67, 97, 238, 0.5);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-track {
            background-color: transparent;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
              <img src="https://i.imgur.com/y6PPObQ.jpeg" alt="Pharmac Logo">
              <span>Pharmac-Online</span>
            </div>
            <div class="cart-icon" id="cart-icon">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-count">0</span>
            </div>
        </div>
    </header>

    <div class="search-container">
        <div class="search-tabs">
            <button class="search-tab active" data-tab="name">Search by Name</button>
            <button class="search-tab" data-tab="tags">Search by Tags</button>
        </div>
        <div class="search-box">
            <input type="text" class="search-input" id="search-input" placeholder="Search medications...">
            <button class="search-button" id="search-button">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>

    <div class="categories-container" id="categories-container">
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading medications...</p>
        </div>
    </div>

    <!-- Cart Page -->
    <div class="cart-page" id="cart-page">
        <div class="page-header">
            <h2 class="page-title">Your Cart</h2>
            <button class="close-page" id="close-cart">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="cart-items" id="cart-items">
            <!-- Cart items will be loaded here -->
        </div>
        
        <div class="cart-summary" id="cart-summary">
            <div class="summary-row">
                <span>Subtotal</span>
                <span id="cart-subtotal">₦0.00</span>
            </div>
            <div class="summary-row">
                <span>Delivery</span>
                <span>₦0.00</span>
            </div>
            <div class="summary-row summary-total">
                <span>Total</span>
                <span id="cart-total">₦0.00</span>
            </div>
            <button class="checkout-btn">Proceed to Checkout</button>
        </div>
    </div>

    <!-- Prescription Page -->
    <div class="prescription-page" id="prescription-page">
        <div class="page-header">
            <h2 class="page-title">Prescription Medications</h2>
            <button class="close-page" id="close-prescription">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="prescription-items" id="prescription-items">
            <!-- Prescription items will be loaded here -->
        </div>
    </div>

    <!-- Account Page -->
    <div class="account-page" id="account-page">
        <div class="page-header">
            <h2 class="page-title">My Account</h2>
            <button class="close-page" id="close-account">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="account-form" id="account-form">
            <!-- Account details will be loaded here -->
        </div>
    </div>

    <footer>
        <div class="footer-icon active" id="home-btn">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </div>
        <div class="footer-icon" id="cart-btn">
            <i class="fas fa-shopping-cart"></i>
            <span>Cart</span>
        </div>
        <div class="footer-icon" id="prescription-btn">
            <i class="fas fa-prescription"></i>
            <span>Prescriptions</span>
        </div>
        <div class="footer-icon" id="account-btn">
            <i class="fas fa-user"></i>
            <span>Account</span>
        </div>
    </footer>

    <div class="notification" id="notification"></div>

    <script>
        try {
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCNMdcbXVMC_QUgVSmgFMXlW84DWQs9QZE",
                authDomain: "pharmac-online.firebaseapp.com",
                projectId: "pharmac-online",
                storageBucket: "pharmac-online.appspot.com",
                messagingSenderId: "968868548902",
                appId: "1:968868548902:web:0607bd63857c7c538131e7"
            };

            // Initialize Firebase
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.firestore();

            // DOM elements
            const categoriesContainer = document.getElementById('categories-container');
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const searchTabs = document.querySelectorAll('.search-tab');
            const cartCountElement = document.querySelector('.cart-count');
            const cartIcon = document.getElementById('cart-icon');
            const cartPage = document.getElementById('cart-page');
            const closeCart = document.getElementById('close-cart');
            const cartItemsContainer = document.getElementById('cart-items');
            const cartSubtotal = document.getElementById('cart-subtotal');
            const cartTotal = document.getElementById('cart-total');
            const cartBtn = document.getElementById('cart-btn');
            const homeBtn = document.getElementById('home-btn');
            const prescriptionBtn = document.getElementById('prescription-btn');
            const prescriptionPage = document.getElementById('prescription-page');
            const closePrescription = document.getElementById('close-prescription');
            const prescriptionItemsContainer = document.getElementById('prescription-items');
            const accountBtn = document.getElementById('account-btn');
            const accountPage = document.getElementById('account-page');
            const closeAccount = document.getElementById('close-account');
            const accountFormContainer = document.getElementById('account-form');
            const notification = document.getElementById('notification');
            let currentSearchType = 'name';
            let enableAutoScroll = false;


            // Global variables
            let allProducts = [];
            let cartCount = 0;
            let userEmail = '';
            let cartDocRef = null;
            let autoScrollIntervals = {};

            // Slide management functions
            function goToSlide(category, slideIndex) {
                const slider = document.querySelector(`.products-slider[data-category="${category}"]`);
                const controls = slider?.closest('.category-section')?.querySelector('.slider-controls');
                
                if (slider) {
                    // Calculate the translateX value based on slide index
                    const translateX = -(slideIndex * 100);
                    slider.style.transform = `translateX(${translateX}%)`;
                    
                    // Update active dot if controls exist
                    if (controls) {
                        const dots = controls.querySelectorAll('.slider-dot');
                        dots.forEach((dot, index) => {
                            if (index === slideIndex) {
                                dot.classList.add('active');
                            } else {
                                dot.classList.remove('active');
                            }
                        });
                    }
                }
            }

            function setupAutoScroll(category, productCount) {
                if (!enableAutoScroll) {
                    if (autoScrollIntervals[category]) {
                        clearInterval(autoScrollIntervals[category]);
                    }
                    return;
                }

                // existing code remains
                if (autoScrollIntervals[category]) {
                    clearInterval(autoScrollIntervals[category]);
                }
                
                if (productCount <= 2) return;
                
                const slideCount = Math.ceil(productCount / 2);
                let currentSlide = 0;

                goToSlide(category, currentSlide);

                autoScrollIntervals[category] = setInterval(() => {
                    currentSlide = (currentSlide + 1) % slideCount;
                    goToSlide(category, currentSlide);
                }, 3000);
            }


            function setupSwipeEvents(slider, category, productCount) {
                if (productCount <= 2) return;

                let touchStartX = 0;
                let touchStartY = 0;
                let touchEndX = 0;
                let isSwiping = false;
                const slideCount = Math.ceil(productCount / 2);
                let currentSlide = 0;
                let isHorizontalSwipe = false;

                slider.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                    touchStartY = e.changedTouches[0].screenY;
                    isSwiping = true;
                    isHorizontalSwipe = false;
                    if (autoScrollIntervals[category]) {
                        clearInterval(autoScrollIntervals[category]);
                    }
                }, { passive: false });

                slider.addEventListener('touchmove', (e) => {
                    if (!isSwiping) return;

                    const currentX = e.changedTouches[0].screenX;
                    const currentY = e.changedTouches[0].screenY;
                    const deltaX = currentX - touchStartX;
                    const deltaY = currentY - touchStartY;

                    // Check if it's horizontal
                    if (Math.abs(deltaX) > Math.abs(deltaY)) {
                        isHorizontalSwipe = true;
                        e.preventDefault(); // block scroll
                    } else {
                        isHorizontalSwipe = false;
                        // allow vertical scroll — do NOT call preventDefault
                    }
                }, { passive: false });

                slider.addEventListener('touchend', (e) => {
                    if (!isSwiping) return;

                    if (isHorizontalSwipe) {
                        touchEndX = e.changedTouches[0].screenX;
                        handleSwipe();
                    }

                    isSwiping = false;

                    setTimeout(() => {
                        setupAutoScroll(category, productCount);
                    }, 1000);
                }, { passive: false });

                function handleSwipe() {
                    const threshold = 50;

                    if (touchEndX < touchStartX - threshold) {
                        currentSlide = (currentSlide + 1) % slideCount;
                        goToSlide(category, currentSlide);
                    } else if (touchEndX > touchStartX + threshold) {
                        currentSlide = (currentSlide - 1 + slideCount) % slideCount;
                        goToSlide(category, currentSlide);
                    }
                }
            }



            // Get email parameter from URL
            function getEmailFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('email') || '';
            }

            // Get cart count for user
            async function getCartCount() {
                if (!userEmail) return 0;
                
                try {
                    const cartQuery = await db.collection('Cart')
                        .where('email_address', '==', userEmail)
                        .limit(1)
                        .get();
                    
                    if (cartQuery.empty) return 0;
                    
                    cartDocRef = cartQuery.docs[0].ref;
                    const itemsSnapshot = await cartDocRef.collection('Items')
                        .where('status', '==', 'Active')
                        .get();
                    
                    return itemsSnapshot.size;
                } catch (error) {
                    console.error('Error getting cart count:', error);
                    return 0;
                }
            }

            // Update cart count display
            async function updateCartCount() {
                cartCount = await getCartCount();
                cartCountElement.textContent = cartCount;
            }

            // Show notification
            function showNotification(message, duration = 3000) {
                notification.textContent = message;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duration);
            }

            // Event listeners
            searchButton.addEventListener('click', handleSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSearch();
            });
            // NEW: automatically refresh when input is cleared
            searchInput.addEventListener('input', () => {
                if (!searchInput.value.trim()) {
                    displayProductsByCategory(allProducts);
                }
            });

            searchTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    searchTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentSearchType = tab.dataset.tab;
                    searchInput.placeholder = currentSearchType === 'name' 
                        ? 'Search medications...' 
                        : 'Search by tags like pain, fever...';
                    if (searchInput.value) handleSearch();
                });
            });

            // Cart event listeners
            cartIcon.addEventListener('click', openCart);
            closeCart.addEventListener('click', closeCartPage);
            cartBtn.addEventListener('click', openCart);
            homeBtn.addEventListener('click', showHomePage);
            
            // Prescription event listeners
            prescriptionBtn.addEventListener('click', showPrescriptionPage);
            closePrescription.addEventListener('click', showHomePage);
            
            // Account event listeners
            accountBtn.addEventListener('click', showAccountPage);
            closeAccount.addEventListener('click', showHomePage);

            // Initialize the app
            document.addEventListener('DOMContentLoaded', initApp);

            // Functions
            async function initApp() {
                console.log("Initializing pharmacy app...");
                userEmail = getEmailFromURL();

                if (!userEmail) {
                    console.warn("No email parameter found — user not logged in");

                    // Show a top warning banner but allow the app to continue
                    const warningBanner = document.createElement("div");
                    warningBanner.textContent = "🔒 Not logged in — some features may be disabled.";
                    warningBanner.style.background = "#fce8e6";
                    warningBanner.style.color = "#d93025";
                    warningBanner.style.padding = "10px";
                    warningBanner.style.textAlign = "center";
                    warningBanner.style.fontSize = "0.85rem";
                    warningBanner.style.fontWeight = "500";
                    warningBanner.style.position = "sticky";
                    warningBanner.style.top = "0";
                    warningBanner.style.zIndex = "1001";

                    // Insert banner before everything else in the body
                    document.body.insertBefore(warningBanner, document.body.firstChild);
                } else {
                    console.log("User email:", userEmail);
                    await updateCartCount();
                }

                // Always fetch products and set up service worker
                await fetchProducts();
                setupServiceWorker();
            }

            async function fetchProducts() {
                try {
                    console.log("Fetching products from Firestore...");
                    
                    const allSnapshot = await db.collection('Products').get();
                    console.log(`Found ${allSnapshot.size} total products`);
                    
                    if (allSnapshot.empty) {
                        showError("No products found in database");
                        return;
                    }

                    allProducts = allSnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            category: data.category || 'Other',
                            tags: data.tags || []
                        };
                    }).filter(product => {
                        const stockValue = String(product.stock).toLowerCase().trim();
                        return stockValue.includes('available') || 
                               stockValue.includes('in stock') ||
                               stockValue === 'true';
                    });

                    console.log(`Found ${allProducts.length} available products`);
                    displayProductsByCategory(allProducts);
                    
                } catch (error) {
                    console.error("Error fetching products:", error);
                    showError(`Failed to load products: ${error.message}`);
                }
            }

            function displayProductsByCategory(products) {
                if (!products || products.length === 0) {
                    categoriesContainer.innerHTML = `
                        <div class="no-results">
                            <p>No medications found matching your criteria.</p>
                        </div>
                    `;
                    return;
                }

                // Clear any existing auto-scroll intervals
                Object.values(autoScrollIntervals).forEach(interval => clearInterval(interval));
                autoScrollIntervals = {};

                // Group products by category
                const categories = {};
                products.forEach(product => {
                    if (!categories[product.category]) {
                        categories[product.category] = [];
                    }
                    categories[product.category].push(product);
                });

                // Sort categories alphabetically
                const sortedCategories = Object.keys(categories).sort();

                // Display each category
                categoriesContainer.innerHTML = '';
                sortedCategories.forEach(category => {
                    const categoryProducts = categories[category];
                    const categorySection = document.createElement('div');
                    categorySection.className = 'category-section';
                    
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'category-header';
                    categoryHeader.innerHTML = `
                        <h2 class="category-title">${category}</h2>
                    `;
                    
                    // Create products container with slider
                    const productsContainer = document.createElement('div');
                    productsContainer.className = 'products-container';
                    
                    const productsSlider = document.createElement('div');
                    productsSlider.className = 'products-slider';
                    productsSlider.dataset.category = category;
                    
                    // Add all products to the slider
                    categoryProducts.forEach(product => {
                        productsSlider.appendChild(createProductCard(product));
                    });
                    
                    productsContainer.appendChild(productsSlider);
                    categorySection.appendChild(categoryHeader);
                    categorySection.appendChild(productsContainer);
                    
                    // Add slider controls if there are more than 2 products
                    if (categoryProducts.length > 2) {
                        const sliderControls = document.createElement('div');
                        sliderControls.className = 'slider-controls';
                        
                        // Calculate number of slides needed (2 products per slide)
                        const slideCount = Math.ceil(categoryProducts.length / 2);
                        
                        // Create dots for each slide
                        for (let i = 0; i < slideCount; i++) {
                            const dot = document.createElement('div');
                            dot.className = 'slider-dot';
                            if (i === 0) dot.classList.add('active');
                            dot.dataset.slide = i;
                            dot.dataset.category = category;
                            dot.addEventListener('click', () => {
                                goToSlide(category, i);
                            });
                            sliderControls.appendChild(dot);
                        }
                        
                        categorySection.appendChild(sliderControls);
                        
                        
                        
                        // Set up touch/swipe events
                        setupSwipeEvents(productsSlider, category, categoryProducts.length);
                    }
                    
                    categoriesContainer.appendChild(categorySection);
                });
            }

            // Modified createProductCard function
            function createProductCard(product) {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.id = product.id;
                
                const formattedPrice = product.price ? 
                    `₦${product.price.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : 
                    '₦0.00';
                
                card.innerHTML = `
                    <img src="${product.imageUrl || 'https://via.placeholder.com/300x180?text=No+Image'}" 
                         alt="${product.productName}" 
                         class="product-image"
                         onerror="this.src='https://via.placeholder.com/300x180?text=Image+Error'">
                    <div class="product-info">
                        <h3 class="product-name">${product.productName}</h3>
                        <p class="product-brand">${product.brandName || 'Generic'}</p>
                        <p class="product-price">${formattedPrice}</p>
                        <div class="stock-badge-container">
                            <span class="product-stock">In Stock</span>
                            ${product.prescriptionRequired ? '<span class="prescription-badge">Rx Required</span>' : ''}
                        </div>
                        <div class="add-to-cart-container">
                            <input type="number" class="quantity-input" min="1" value="1" placeholder="Qty">
                            <button class="add-to-cart-btn">
                                <span class="btn-text">Add to cart</span>
                                <span class="spinner"></span>
                            </button>
                        </div>
                    </div>
                `;
                
                // Add to cart functionality
                const addToCartBtn = card.querySelector('.add-to-cart-btn');
                const quantityInput = card.querySelector('.quantity-input');
                
                addToCartBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const quantity = parseInt(quantityInput.value) || 1;
                    
                    if (quantity < 1) {
                        showNotification('Please enter a valid quantity');
                        return;
                    }
                    
                    try {
                        // Disable button and show spinner
                        addToCartBtn.disabled = true;
                        addToCartBtn.classList.add('loading');
                        
                        await addToCart(product, quantity);
                        await updateCartCount();
                        
                        showNotification(`${quantity} ${product.productName} added to cart`);
                    } catch (error) {
                        console.error('Error adding to cart:', error);
                        showNotification('Failed to add to cart. Please try again.');
                    } finally {
                        // Re-enable button and hide spinner
                        addToCartBtn.disabled = false;
                        addToCartBtn.classList.remove('loading');
                    }
                });
                
                return card;
            }

            async function addToCart(product, quantity) {
                if (!userEmail) {
                    throw new Error('No user email available');
                }
                
                // Check if cart document exists for this user
                const cartQuery = await db.collection('Cart')
                    .where('email_address', '==', userEmail)
                    .limit(1)
                    .get();
                
                let cartRef;
                const now = new Date();
                
                if (cartQuery.empty) {
                    // Create new cart document
                    cartRef = await db.collection('Cart').add({
                        email_address: userEmail,
                        created_at: now,
                        updated_at: now
                    });
                    cartDocRef = cartRef;
                } else {
                    cartRef = cartQuery.docs[0].ref;
                    cartDocRef = cartRef;
                    // Update the updated_at field
                    await cartRef.update({
                        updated_at: now
                    });
                }
                
                // Check if product already exists in cart
                const existingItemQuery = await cartRef.collection('Items')
                    .where('product_id', '==', product.id)
                    .where('status', '==', 'Active')
                    .limit(1)
                    .get();
                
                if (!existingItemQuery.empty) {
                    // Update existing item
                    const existingItem = existingItemQuery.docs[0];
                    const currentQty = existingItem.data().quantity || 0;
                    await existingItem.ref.update({
                        quantity: currentQty + quantity,
                        updated_at: now
                    });
                } else {
                    // Add new item to cart
                    await cartRef.collection('Items').add({
                        product_id: product.id,
                        product_name: product.productName,
                        price_per_unit: product.price || 0,
                        quantity: quantity,
                        status: 'Active',
                        created_at: now,
                        updated_at: now,
                        image_url: product.imageUrl || ''
                    });
                }
            }

            function handleSearch() {
                const searchTerm = searchInput.value.trim().toLowerCase();
                
                if (!searchTerm) {
                    displayProductsByCategory(allProducts);
                    return;
                }
                
                let filteredProducts;
                
                if (currentSearchType === 'name') {
                    filteredProducts = allProducts.filter(product => 
                        product.productName.toLowerCase().includes(searchTerm) ||
                        (product.brandName && product.brandName.toLowerCase().includes(searchTerm))
                    );
                } else { // search by tags
                    filteredProducts = allProducts.filter(product => 
                        product.tags.some(tag => tag.toLowerCase().includes(searchTerm))
                    );
                }
                
                displayProductsByCategory(filteredProducts);
            }

            function showError(message) {
                categoriesContainer.innerHTML = `
                    <div class="error-message">
                        <p>${message}</p>
                        <p>Please try again later or contact support.</p>
                    </div>
                `;
            }

            function setupServiceWorker() {
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('/sw.js').then(registration => {
                            console.log('ServiceWorker registration successful');
                        }).catch(err => {
                            console.log('ServiceWorker registration failed: ', err);
                        });
                    });
                }
            }

            // Page navigation functions
            function showHomePage() {
                cartPage.style.display = 'none';
                prescriptionPage.style.display = 'none';
                accountPage.style.display = 'none';
                categoriesContainer.style.display = 'block';
                document.querySelector('.search-container').style.display = 'block';
                
                document.querySelectorAll('.footer-icon').forEach(icon => {
                    icon.classList.remove('active');
                });
                homeBtn.classList.add('active');
            }

            // Cart functions
            async function openCart() {
                if (!userEmail) {
                    showNotification('Please login to view your cart');
                    return;
                }
                
                try {
                    // Hide other pages and show cart
                    prescriptionPage.style.display = 'none';
                    accountPage.style.display = 'none';
                    categoriesContainer.style.display = 'none';
                    document.querySelector('.search-container').style.display = 'none';
                    cartPage.style.display = 'block';
                    
                    // Update footer icons
                    document.querySelectorAll('.footer-icon').forEach(icon => {
                        icon.classList.remove('active');
                    });
                    cartBtn.classList.add('active');
                    
                    // Load cart items
                    await loadCartItems();
                } catch (error) {
                    console.error('Error opening cart:', error);
                    showNotification('Failed to load cart. Please try again.');
                }
            }

            function closeCartPage() {
                showHomePage();
            }

            async function loadCartItems() {
                if (!userEmail) {
                    showEmptyCart();
                    return;
                }

                if (!cartDocRef) {
                    const cartQuery = await db.collection('Cart')
                        .where('email_address', '==', userEmail)
                        .limit(1)
                        .get();
                    
                    if (cartQuery.empty) {
                        showEmptyCart();
                        return;
                    }
                    
                    cartDocRef = cartQuery.docs[0].ref;
                }
                
                const itemsSnapshot = await cartDocRef.collection('Items')
                    .where('status', '==', 'Active')
                    .get();
                
                if (itemsSnapshot.empty) {
                    showEmptyCart();
                    return;
                }
                
                let subtotal = 0;
                cartItemsContainer.innerHTML = '';
                
                itemsSnapshot.forEach(async doc => {
                    const item = doc.data();
                    const product = allProducts.find(p => p.id === item.product_id) || {
                        productName: item.product_name,
                        price: item.price_per_unit,
                        imageUrl: item.image_url || 'https://via.placeholder.com/150?text=No+Image'
                    };
                    
                    const itemTotal = item.price_per_unit * item.quantity;
                    subtotal += itemTotal;
                    
                    const formattedPrice = `₦${item.price_per_unit.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    const formattedTotal = `₦${itemTotal.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    
                    const cartItem = document.createElement('div');
                    cartItem.className = 'cart-item';
                    cartItem.dataset.id = doc.id;
                    cartItem.innerHTML = `
                        <img src="${product.imageUrl}" alt="${product.productName}" class="cart-item-image">
                        <div class="cart-item-details">
                            <h3 class="cart-item-name">${product.productName}</h3>
                            <p class="cart-item-price">${formattedPrice}</p>
                            <div class="cart-item-quantity">
                                <div class="quantity-control">
                                    <button class="quantity-btn minus">-</button>
                                    <span class="quantity-value">${item.quantity}</span>
                                    <button class="quantity-btn plus">+</button>
                                </div>
                                <span class="remove-item">Remove</span>
                            </div>
                        </div>
                    `;
                    
                    // Add event listeners for quantity controls
                    const minusBtn = cartItem.querySelector('.minus');
                    const plusBtn = cartItem.querySelector('.plus');
                    const quantityValue = cartItem.querySelector('.quantity-value');
                    const removeBtn = cartItem.querySelector('.remove-item');
                    
                    minusBtn.addEventListener('click', async () => {
                        const newQty = parseInt(quantityValue.textContent) - 1;
                        if (newQty > 0) {
                            await updateCartItem(doc.id, newQty);
                            quantityValue.textContent = newQty;
                            await updateCartSummary();
                        } else {
                            await removeCartItem(doc.id);
                            cartItem.remove();
                            await updateCartSummary();
                            await updateCartCount();
                        }
                    });
                    
                    plusBtn.addEventListener('click', async () => {
                        const newQty = parseInt(quantityValue.textContent) + 1;
                        await updateCartItem(doc.id, newQty);
                        quantityValue.textContent = newQty;
                        await updateCartSummary();
                    });
                    
                    removeBtn.addEventListener('click', async () => {
                        await removeCartItem(doc.id);
                        cartItem.remove();
                        await updateCartSummary();
                        await updateCartCount();
                        
                        // Check if cart is now empty
                        const updatedSnapshot = await cartDocRef.collection('Items')
                            .where('status', '==', 'Active')
                            .get();
                        
                        if (updatedSnapshot.empty) {
                            showEmptyCart();
                        }
                    });
                    
                    cartItemsContainer.appendChild(cartItem);
                });
                
                // Update summary
                updateCartSummary(subtotal);
            }

            async function updateCartItem(itemId, newQuantity) {
                await cartDocRef.collection('Items').doc(itemId).update({
                    quantity: newQuantity,
                    updated_at: new Date()
                });
            }

            async function removeCartItem(itemId) {
                await cartDocRef.collection('Items').doc(itemId).update({
                    status: 'Removed',
                    updated_at: new Date()
                });
            }

            async function updateCartSummary(subtotal = null) {
                if (subtotal === null) {
                    // Recalculate subtotal if not provided
                    subtotal = 0;
                    const itemsSnapshot = await cartDocRef.collection('Items')
                        .where('status', '==', 'Active')
                        .get();
                    
                    itemsSnapshot.forEach(doc => {
                        const item = doc.data();
                        subtotal += item.price_per_unit * item.quantity;
                    });
                }
                
                const formattedSubtotal = `₦${subtotal.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                const formattedTotal = `₦${subtotal.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
                cartSubtotal.textContent = formattedSubtotal;
                cartTotal.textContent = formattedTotal;
            }

            function showEmptyCart() {
                cartItemsContainer.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Your cart is empty</p>
                        <p class="back-to-shop" id="back-to-shop">Continue Shopping</p>
                    </div>
                `;
                
                document.getElementById('back-to-shop').addEventListener('click', showHomePage);
                
                // Hide summary when cart is empty
                document.getElementById('cart-summary').style.display = 'none';
            }

            // Prescription page functions
            async function showPrescriptionPage() {
                try {
                    // Hide other pages and show prescription page
                    cartPage.style.display = 'none';
                    accountPage.style.display = 'none';
                    categoriesContainer.style.display = 'none';
                    document.querySelector('.search-container').style.display = 'none';
                    prescriptionPage.style.display = 'block';
                    
                    // Update footer icons
                    document.querySelectorAll('.footer-icon').forEach(icon => {
                        icon.classList.remove('active');
                    });
                    prescriptionBtn.classList.add('active');
                    
                    // Load prescription items
                    await loadPrescriptionItems();
                } catch (error) {
                    console.error('Error opening prescription page:', error);
                    showNotification('Failed to load prescription medications. Please try again.');
                }
            }

            async function loadPrescriptionItems() {
                // Filter products to only show prescription medications
                const prescriptionProducts = allProducts.filter(product => product.prescriptionRequired === true);
                
                if (prescriptionProducts.length === 0) {
                    prescriptionItemsContainer.innerHTML = `
                        <div class="empty-cart">
                            <i class="fas fa-prescription"></i>
                            <p>No prescription medications found</p>
                            <p class="back-to-shop" id="back-to-prescriptions">Back to Home</p>
                        </div>
                    `;
                    
                    document.getElementById('back-to-prescriptions').addEventListener('click', showHomePage);
                    return;
                }
                
                // Clear any existing auto-scroll intervals
                Object.values(autoScrollIntervals).forEach(interval => clearInterval(interval));
                autoScrollIntervals = {};
                
                // Group products by category
                const categories = {};
                prescriptionProducts.forEach(product => {
                    if (!categories[product.category]) {
                        categories[product.category] = [];
                    }
                    categories[product.category].push(product);
                });
                
                // Sort categories alphabetically
                const sortedCategories = Object.keys(categories).sort();
                
                // Display each category
                prescriptionItemsContainer.innerHTML = '';
                sortedCategories.forEach(category => {
                    const categoryProducts = categories[category];
                    const categorySection = document.createElement('div');
                    categorySection.className = 'category-section';
                    
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'category-header';
                    categoryHeader.innerHTML = `
                        <h2 class="category-title">${category}</h2>
                    `;
                    
                    // Create products container with slider
                    const productsContainer = document.createElement('div');
                    productsContainer.className = 'products-container';
                    
                    const productsSlider = document.createElement('div');
                    productsSlider.className = 'products-slider';
                    productsSlider.dataset.category = `prescription-${category}`;
                    
                    // Add all products to the slider
                    categoryProducts.forEach(product => {
                        productsSlider.appendChild(createProductCard(product));
                    });
                    
                    productsContainer.appendChild(productsSlider);
                    categorySection.appendChild(categoryHeader);
                    categorySection.appendChild(productsContainer);
                    
                    // Add slider controls if there are more than 2 products
                    if (categoryProducts.length > 2) {
                        const sliderControls = document.createElement('div');
                        sliderControls.className = 'slider-controls';
                        
                        // Calculate number of slides needed (2 products per slide)
                        const slideCount = Math.ceil(categoryProducts.length / 2);
                        
                        // Create dots for each slide
                        for (let i = 0; i < slideCount; i++) {
                            const dot = document.createElement('div');
                            dot.className = 'slider-dot';
                            if (i === 0) dot.classList.add('active');
                            dot.dataset.slide = i;
                            dot.dataset.category = `prescription-${category}`;
                            dot.addEventListener('click', () => {
                                goToSlide(`prescription-${category}`, i);
                            });
                            sliderControls.appendChild(dot);
                        }
                        
                        categorySection.appendChild(sliderControls);
                        
                        // Set up auto-scrolling for this category
                        
                        
                        // Set up touch/swipe events
                        setupSwipeEvents(productsSlider, `prescription-${category}`, categoryProducts.length);
                    }
                    
                    prescriptionItemsContainer.appendChild(categorySection);
                });
            }

            // Account page functions
            async function showAccountPage() {
                if (!userEmail) {
                    showNotification('Please login to view your account');
                    return;
                }
                
                try {
                    // Hide other pages and show account page
                    cartPage.style.display = 'none';
                    prescriptionPage.style.display = 'none';
                    categoriesContainer.style.display = 'none';
                    document.querySelector('.search-container').style.display = 'none';
                    accountPage.style.display = 'block';
                    
                    // Update footer icons
                    document.querySelectorAll('.footer-icon').forEach(icon => {
                        icon.classList.remove('active');
                    });
                    accountBtn.classList.add('active');
                    
                    // Load account details
                    await loadAccountDetails();
                } catch (error) {
                    console.error('Error opening account page:', error);
                    showNotification('Failed to load account details. Please try again.');
                }
            }

            async function loadAccountDetails() {
                // Query the database for user details
                const usersQuery = await db.collection('Users')
                    .where('email', '==', userEmail)
                    .limit(1)
                    .get();
                
                if (usersQuery.empty) {
                    accountFormContainer.innerHTML = `
                        <div class="error-message">
                            <p>User account not found</p>
                        </div>
                    `;
                    return;
                }
                
                const userData = usersQuery.docs[0].data();
                const displayName = userData.display_name || '';
                const firstNameLetter = displayName ? displayName.charAt(0).toUpperCase() : 'U';
                const phoneNumber = userData.phone_number || '';
                const deliveryAddress = userData.delivery_address || '';
                const city = userData.city || '';
                const state = userData.state || '';
                
                // Create account form
                accountFormContainer.innerHTML = `
                    <div class="user-avatar">${firstNameLetter}</div>
                    <form id="account-form">
                        <div class="form-group">
                            <label class="form-label">Display Name</label>
                            <input type="text" class="form-input" value="${displayName}" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" value="${userEmail}" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" id="phone-number" value="${phoneNumber}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Delivery Address</label>
                            <input type="text" class="form-input" id="delivery-address" value="${deliveryAddress}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">City</label>
                            <input type="text" class="form-input" id="city" value="${city}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">State</label>
                            <input type="text" class="form-input" id="state" value="${state}">
                        </div>
                        <button type="button" class="save-btn" id="save-account">
                            Save Changes
                            <span class="spinner"></span>
                        </button>
                    </form>
                `;
                
                // Add event listener for save button
                const saveBtn = document.getElementById('save-account');
                saveBtn.addEventListener('click', async () => {
                    try {
                        saveBtn.disabled = true;
                        saveBtn.classList.add('loading');
                        
                        const updatedData = {
                            phone_number: document.getElementById('phone-number').value,
                            delivery_address: document.getElementById('delivery-address').value,
                            city: document.getElementById('city').value,
                            state: document.getElementById('state').value,
                            updated_at: new Date()
                        };
                        
                        await usersQuery.docs[0].ref.update(updatedData);
                        showNotification('Account details updated successfully');
                    } catch (error) {
                        console.error('Error updating account:', error);
                        showNotification('Failed to update account. Please try again.');
                    } finally {
                        saveBtn.disabled = false;
                        saveBtn.classList.remove('loading');
                    }
                });
            }

         } catch (error) {
            console.error("Fatal error in application:", error);
            document.getElementById('categories-container').innerHTML = `
                <div class="error-message">
                    <h3>Application Error</h3>
                    <p>${error.message}</p>
                    <p>Please refresh the page or try again later.</p>
                </div>
            `;
        }
    </script>
</body>
</html>
